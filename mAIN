import React, { useState, useEffect, useRef, useMemo, useCallback } from 'react';
import { Map, List, Wallet, Info, MessageCircle, Plus, X, Coffee, ShoppingBag, Utensils, Train, MapPin, Volume2, ChevronUp, User, ArrowRight, Edit2, Trash2, Link as LinkIcon, Navigation, RotateCcw, Star, Calendar, DollarSign, Calculator, Plane, Home, Phone, PieChart, Languages, Mic } from 'lucide-react';

// --- è¨­å®šèˆ‡æ¨£å¼ ---
const COLORS = {
  bg: 'bg-[#F9F8F4]',
  text: 'text-[#5A5A5A]',
  card: 'bg-white',
  border: 'border-[#E0E0E0]',
};

// è¡Œç¨‹å¤©æ•¸é¡è‰² (Day 1 - Day 5) - æ·¡è«è˜­è¿ªè‰²
const DAY_COLORS = {
  1: '#C4D4DC', 
  2: '#EED0D0', 
  3: '#C8D9B8', 
  4: '#EBE0B8', 
  5: '#B8C4B0', 
};

// ç”¨æ–¼æ–‡å­—çš„æ·±è‰²ç‰ˆæœ¬
const DAY_TEXT_COLORS = {
  1: '#5D707A',
  2: '#8E5E5E',
  3: '#5F754A',
  4: '#7D6D45',
  5: '#4E5C48',
};

const DATES = { 1: '1/5', 2: '1/6', 3: '1/7', 4: '1/8', 5: '1/9' };

const TYPE_STYLES = {
  food: { emoji: 'ğŸ´', label: 'æ­£é¤' },
  dessert: { emoji: 'ğŸ°', label: 'ç”œé»' },
  coffee: { emoji: 'â˜•', label: 'å’–å•¡' },
  bread: { emoji: 'ğŸ¥–', label: 'éºµåŒ…' },
  shopping: { emoji: 'ğŸ›ï¸', label: 'è³¼ç‰©' },
  spot: { emoji: 'â›©ï¸', label: 'æ™¯é»' },
  transport: { emoji: 'ğŸš‡', label: 'äº¤é€š' },
  accommodation: { emoji: 'ğŸ›ï¸', label: 'ä½å®¿' },
  default: { emoji: 'ğŸ“', label: 'å…¶ä»–' }
};

const EXPENSE_CATEGORY_STYLES = {
  'é£Ÿ': { bg: 'bg-[#FFCCBC]', text: 'text-[#D84315]', icon: <Utensils size={18} /> },
  'è³¼ç‰©': { bg: 'bg-[#F8BBD0]', text: 'text-[#C2185B]', icon: <ShoppingBag size={18} /> },
  'ä½å®¿': { bg: 'bg-[#C5CAE9]', text: 'text-[#303F9F]', icon: <div className="text-sm">ğŸ›ï¸</div> },
  'äº¤é€š': { bg: 'bg-[#B3E5FC]', text: 'text-[#0277BD]', icon: <Train size={18} /> },
  'æ™¯é»': { bg: 'bg-[#C8E6C9]', text: 'text-[#2E7D32]', icon: <MapPin size={18} /> },
  'å…¶ä»–': { bg: 'bg-[#E0E0E0]', text: 'text-[#616161]', icon: <div className="text-sm">ğŸ“</div> },
};

// --- æ—¥èªè³‡æ–™åº« ---
const INITIAL_JAPANESE_DATA = [
  // äº¤é€š - æœƒè©±
  { id: 't1', category: 'äº¤é€š', type: 'conversation', jp: 'äº¬éƒ½é§…ã¯ã©ã“ã§ã™ã‹ï¼Ÿ', romaji: 'Kyoto-eki wa doko desu ka?', cn: 'è«‹å•äº¬éƒ½è»Šç«™åœ¨å“ªè£¡ï¼Ÿ' },
  { id: 't2', category: 'äº¤é€š', type: 'conversation', jp: 'ã“ã®é›»è»Šã¯åµå±±ã«è¡Œãã¾ã™ã‹ï¼Ÿ', romaji: 'Kono densha wa Arashiyama ni ikimasu ka?', cn: 'é€™ç­é›»è»Šæœ‰åˆ°åµå±±å—ï¼Ÿ' },
  { id: 't3', category: 'äº¤é€š', type: 'conversation', jp: 'åˆ‡ç¬¦å£²ã‚Šå ´ã¯ã©ã“ã§ã™ã‹ï¼Ÿ', romaji: 'Kippu uriba wa doko desu ka?', cn: 'å”®ç¥¨è™•åœ¨å“ªè£¡ï¼Ÿ' },
  // äº¤é€š - å–®å­—
  { id: 'tw1', category: 'äº¤é€š', type: 'vocabulary', jp: 'åœ°ä¸‹é‰„', romaji: 'Chikatetsu', cn: 'åœ°éµ' },
  { id: 'tw2', category: 'äº¤é€š', type: 'vocabulary', jp: 'ãƒã‚¹åœ', romaji: 'Basutei', cn: 'å…¬è»Šç«™' },
  { id: 'tw3', category: 'äº¤é€š', type: 'vocabulary', jp: 'ä¹—ã‚Šæ›ãˆ', romaji: 'Norikae', cn: 'è½‰ä¹˜' },

  // é¤å»³ - æœƒè©±
  { id: 'r1', category: 'é¤å»³', type: 'conversation', jp: 'äºˆç´„ã—ã¦ã„ã¾ã™ã€‚ãƒªãƒ³ã§ã™ã€‚', romaji: 'Yoyaku shiteimasu. Rin desu.', cn: 'æˆ‘æœ‰é ç´„ï¼Œæˆ‘å§“æ—ã€‚' },
  { id: 'r2', category: 'é¤å»³', type: 'conversation', jp: 'ãŠã™ã™ã‚ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ä½•ã§ã™ã‹ï¼Ÿ', romaji: 'Osusume no menyu wa nan desu ka?', cn: 'æ¨è–¦çš„èœå–®æ˜¯ä»€éº¼ï¼Ÿ' },
  { id: 'r3', category: 'é¤å»³', type: 'conversation', jp: 'ãŠä¼šè¨ˆã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚', romaji: 'Okaikei o onegaishimasu.', cn: 'éº»ç…©çµå¸³ã€‚' },
  { id: 'r4', category: 'é¤å»³', type: 'conversation', jp: 'ãŠæ°´ã‚’ã‚‚ã‚‰ãˆã¾ã™ã‹ï¼Ÿ', romaji: 'Omizu o moraemasu ka?', cn: 'å¯ä»¥çµ¦æˆ‘ä¸€æ¯æ°´å—ï¼Ÿ' },
  // é¤å»³ - å–®å­—
  { id: 'rw1', category: 'é¤å»³', type: 'vocabulary', jp: 'ç¾å‘³ã—ã„', romaji: 'Oishii', cn: 'å¥½åƒ' },
  { id: 'rw2', category: 'é¤å»³', type: 'vocabulary', jp: 'è±šã‚«ãƒ„', romaji: 'Tonkatsu', cn: 'ç‚¸è±¬æ’' },
  { id: 'rw3', category: 'é¤å»³', type: 'vocabulary', jp: 'ç¦ç…™å¸­', romaji: 'Kinenseki', cn: 'ç¦è¸å¸­' },

  // è³¼ç‰© - æœƒè©±
  { id: 's1', category: 'è³¼ç‰©', type: 'conversation', jp: 'ã“ã‚Œã‚’è©¦ç€ã—ã¦ã‚‚ã„ã„ã§ã™ã‹ï¼Ÿ', romaji: 'Kore o shichaku shitemo ii desu ka?', cn: 'å¯ä»¥è©¦ç©¿é€™å€‹å—ï¼Ÿ' },
  { id: 's2', category: 'è³¼ç‰©', type: 'conversation', jp: 'ã“ã‚Œã¯ã„ãã‚‰ã§ã™ã‹ï¼Ÿ', romaji: 'Kore wa ikura desu ka?', cn: 'è«‹å•é€™å€‹å¤šå°‘éŒ¢ï¼Ÿ' },
  { id: 's3', category: 'è³¼ç‰©', type: 'conversation', jp: 'å…ç¨ï¼ˆã‚ã‚“ãœã„ï¼‰ã§ãã¾ã™ã‹ï¼Ÿ', romaji: 'Menzei dekimasu ka?', cn: 'å¯ä»¥é€€ç¨…å—ï¼Ÿ' },
  // è³¼ç‰© - å–®å­—
  { id: 'sw1', category: 'è³¼ç‰©', type: 'vocabulary', jp: 'é ˜åæ›¸', romaji: 'Ryoushuusho', cn: 'æ”¶æ“š' },
  { id: 'sw2', category: 'è³¼ç‰©', type: 'vocabulary', jp: 'ãŠåœŸç”£', romaji: 'Omiyage', cn: 'ä¼´æ‰‹ç¦®' },

  // ç·Šæ€¥ - æœƒè©±
  { id: 'e1', category: 'ç·Šæ€¥', type: 'conversation', jp: 'åŠ©ã‘ã¦ãã ã•ã„ï¼', romaji: 'Tasukete kudasai!', cn: 'è«‹æ•‘æ•‘æˆ‘ï¼' },
  { id: 'e2', category: 'ç·Šæ€¥', type: 'conversation', jp: 'è­¦å¯Ÿã‚’å‘¼ã‚“ã§ãã ã•ã„ã€‚', romaji: 'Keisatsu o yonde kudasai.', cn: 'è«‹å¹«æˆ‘å«è­¦å¯Ÿã€‚' },
  { id: 'e3', category: 'ç·Šæ€¥', type: 'conversation', jp: 'ç—…é™¢ã¯ã©ã“ã§ã™ã‹ï¼Ÿ', romaji: 'Byouin wa doko desu ka?', cn: 'è«‹å•é†«é™¢åœ¨å“ªè£¡ï¼Ÿ' },
  // ç·Šæ€¥ - å–®å­—
  { id: 'ew1', category: 'ç·Šæ€¥', type: 'vocabulary', jp: 'ãƒˆã‚¤ãƒ¬', romaji: 'Toire', cn: 'å»æ‰€' },
  { id: 'ew2', category: 'ç·Šæ€¥', type: 'vocabulary', jp: 'è–¬å±€', romaji: 'Yakkyoku', cn: 'è—¥å±€' },
];

// --- åˆå§‹è³‡æ–™ ---
const INITIAL_ITINERARY = [
  // Day 1
  { id: '1-1', day: 1, time: '13:00', type: 'transport', title: 'é—œè¥¿æ©Ÿå ´', desc: 'æ­ä¹˜ Haruka å‰å¾€äº¬éƒ½', highlight: [] },
  { id: '1-2', day: 1, time: '15:30', type: 'accommodation', title: 'äºŒæ¢èŠ±åœ’é£¯åº—', desc: 'è¾¦ç†å…¥ä½ã€‚', highlight: [] },
  { id: '1-3', day: 1, time: '16:30', type: 'shopping', title: 'æ–°é¢¨é¤¨', desc: 'èˆŠäº¬éƒ½ä¸­å¤®é›»è©±å±€æ”¹å»ºã€‚', highlight: [] },
  { id: '1-4', day: 1, time: '18:30', type: 'food', title: 'ç©ºç¦ªäº­', desc: 'å¿…åƒç‚¸è±¬æ’ (éœ€é ç´„)ã€‚', highlight: ['å¿…åƒ', 'é ç´„'] },
  // Day 2
  { id: '2-1', day: 2, time: '10:00', type: 'food', title: 'æ—©åˆé¤', desc: 'é£¯åº—é™„è¿‘æ‚ é–’äº«ç”¨ã€‚', highlight: [] },
  { id: '2-2', day: 2, time: '12:00', type: 'spot', title: 'æ¸…æ°´å¯º', desc: 'äºŒå¹´é˜ªã€ä¸‰å¹´é˜ªæ¼«æ­¥ã€‚', highlight: ['å¿…è²·ä¼´æ‰‹ç¦®'] },
  { id: '2-3', day: 2, time: '15:30', type: 'spot', title: 'å…«å‚ç¥ç¤¾', desc: 'ç¥‡åœ’ã€èŠ±è¦‹å°è·¯ã€‚', highlight: [] },
  { id: '2-4', day: 2, time: '17:00', type: 'food', title: 'æ™šé¤', desc: 'äº¬éƒ½è»Šç«™å‘¨é‚Šã€‚', highlight: [] },
  // Day 3
  { id: '3-1', day: 3, time: '10:00', type: 'spot', title: 'TeamLab äº¬éƒ½', desc: 'æ²‰æµ¸å¼è—è¡“é«”é©—ã€‚', highlight: ['é ç´„'] },
  { id: '3-2', day: 3, time: '13:00', type: 'spot', title: 'åµå±±æ¸¡æœˆæ©‹', desc: 'ç«¹æ—å°å¾‘ã€å¤©é¾å¯ºã€‚', highlight: ['å¿…æ‹'] },
  { id: '3-3', day: 3, time: '16:00', type: 'spot', title: 'åµå±±æº«æ³‰', desc: 'é¢¨é¢¨ã®æ¹¯ (æ—¥æ­¸æº«æ³‰)ã€‚', highlight: ['æ”¾é¬†'] },
  { id: '3-4', day: 3, time: '18:30', type: 'food', title: 'åä»£è±¬æ’ æ´»', desc: 'äº¬éƒ½è»Šç«™åº—ã€‚', highlight: ['å¿…åƒ'] },
  // Day 4
  { id: '4-1', day: 4, time: '10:00', type: 'bread', title: 'Fiveran', desc: 'äº¬éƒ½ç‰¹è‰²éºµåŒ…åº—ã€‚', highlight: ['å¿…åƒéºµåŒ…'] },
  { id: '4-2', day: 4, time: '11:30', type: 'spot', title: 'è²´èˆ¹ç¥ç¤¾', desc: 'æ°´å åœé«”é©—ã€‚', highlight: ['å¿…è²·å¾¡å®ˆ'] },
  { id: '4-3', day: 4, time: '15:00', type: 'spot', title: 'ä¼è¦‹ç¨»è·å¤§ç¤¾', desc: 'åƒæœ¬é³¥å±…ã€‚', highlight: [] },
  { id: '4-4', day: 4, time: '18:30', type: 'food', title: 'ç‡’è‚‰å¼˜å•†åº—', desc: 'äº¬éƒ½å¡” SANDO åº—ã€‚', highlight: ['å¿…åƒ', 'å’Œç‰›'] },
  // Day 5
  { id: '5-1', day: 5, time: '10:00', type: 'coffee', title: 'å–«èŒ¶ãƒãƒ­ãƒ«', desc: 'äºŒæ¢åŸé™„è¿‘ç¶“å…¸å–«èŒ¶ã€‚', highlight: ['å¾©å¤é¢¨'] },
  { id: '5-2', day: 5, time: '11:00', type: 'spot', title: 'äºŒæ¢åŸ', desc: 'å¤§æ”¿å¥‰é‚„ç™¼ç”Ÿåœ°ã€‚', highlight: [] },
  { id: '5-3', day: 5, time: '13:00', type: 'transport', title: 'å‰å¾€é—œè¥¿æ©Ÿå ´', desc: 'æ­ä¹˜ JR Harukaã€‚', highlight: [] },
];

const INITIAL_MARKERS = [
  // --- Day 1 (ç°è—) ---
  { id: 'm1', x: 550, y: 750, title: 'äºŒæ¢èŠ±åœ’é£¯åº—', jpTitle: 'äºŒæ¡ã‚¬ãƒ¼ãƒ‡ãƒ³', type: 'accommodation', day: 1 },
  { id: 'm2', x: 610, y: 780, title: 'æ–°é¢¨é¤¨', jpTitle: 'æ–°é¢¨é¤¨', type: 'shopping', day: 1 }, 
  { id: 'm3', x: 530, y: 700, title: 'ç©ºç¦ªäº­', jpTitle: 'ç©ºç¦…äº­', type: 'food', day: 1, rating: { tabelog: 3.78, google: 4.2 } }, 
  { id: 'm13', x: 680, y: 760, title: 'Soba Roujina', jpTitle: 'ãã° ã‚ã†ã˜ãª', type: 'food', day: 1, rating: { tabelog: 3.65, google: 4.3 } },
  
  // --- Day 2 (æŸ”ç²‰) ---
  { id: 'm4', x: 880, y: 950, title: 'æ¸…æ°´å¯º', jpTitle: 'æ¸…æ°´å¯º', type: 'spot', day: 2, isLandmark: true },
  { id: 'm5', x: 820, y: 850, title: 'å…«å‚ç¥ç¤¾', jpTitle: 'å…«å‚ç¥ç¤¾', type: 'spot', day: 2, isLandmark: true },
  { id: 'm14', x: 630, y: 880, title: 'è±¬ä¸€æ‹‰éºµ', jpTitle: 'çŒªä¸€', type: 'food', day: 2, rating: { tabelog: 3.71, google: 4.0 } },
  { id: 'm16', x: 780, y: 870, title: 'èŠ±è¦‹å°è·¯', jpTitle: 'èŠ±è¦‹å°è·¯', type: 'spot', day: 2 },
  { id: 'r1', x: 800, y: 840, title: 'Okaru çƒé¾éºµ', jpTitle: 'ãŠã‹ã‚‹', type: 'food', day: 2, rating: { tabelog: 3.59, google: 3.8 } },
  { id: 'r2', x: 810, y: 860, title: 'å…«ä»£ç›®å„€å…µè¡›', jpTitle: 'å…«ä»£ç›®å„€å…µè¡›', type: 'food', day: 2, rating: { tabelog: 3.55, google: 4.0 } },
  
  // --- Day 3 (è‰ç¶ ) ---
  { id: 'm6', x: 100, y: 700, title: 'åµå±±æ¸¡æœˆæ©‹', jpTitle: 'æ¸¡æœˆæ©‹', type: 'spot', day: 3 }, 
  { id: 'm7', x: 120, y: 680, title: 'åµå±±æº«æ³‰', jpTitle: 'é¢¨é¢¨ã®æ¹¯', type: 'spot', day: 3 },
  { id: 'm8', x: 600, y: 1100, title: 'äº¬éƒ½è»Šç«™', jpTitle: 'äº¬éƒ½é§…', type: 'transport', day: 3 }, 
  { id: 'm17', x: 80, y: 650, title: 'ç«¹æ—å°å¾‘', jpTitle: 'ç«¹æ—ã®å°å¾„', type: 'spot', day: 3 },
  { id: 'm20', x: 620, y: 1180, title: 'TeamLab äº¬éƒ½', jpTitle: 'TeamLab', type: 'spot', day: 3 }, 
  { id: 'r3', x: 600, y: 1150, title: 'ä¸­æ‘è—¤å‰', jpTitle: 'ä¸­æ‘è—¤å‰', type: 'dessert', day: 3, rating: { tabelog: 3.55, google: 4.0 } },
  { id: 'r4', x: 620, y: 1080, title: 'åä»£è±¬æ’ æ´»', jpTitle: 'ã‹ã¤ãã‚‰', type: 'food', day: 3, rating: { tabelog: 3.16, google: 3.9 } },
  
  // --- Day 4 (æ²™é»ƒ) ---
  { id: 'm9', x: 600, y: 100, title: 'è²´èˆ¹ç¥ç¤¾', jpTitle: 'è²´èˆ¹ç¥ç¤¾', type: 'spot', day: 4, isLandmark: true }, 
  { id: 'm10', x: 850, y: 1300, title: 'ä¼è¦‹ç¨»è·å¤§ç¤¾', jpTitle: 'ä¼è¦‹ç¨²è·', type: 'spot', day: 4, isLandmark: true }, 
  { id: 'm15', x: 950, y: 200, title: 'å¤§åŸä¸‰åƒé™¢', jpTitle: 'ä¸‰åƒé™¢', type: 'spot', day: 4 },
  { id: 'm18', x: 620, y: 790, title: 'Fiveran', jpTitle: 'ãƒ•ã‚¡ã‚¤ãƒ–ãƒ©ãƒ³', type: 'bread', day: 4, rating: { tabelog: 3.75, google: 4.2 } },
  { id: 'm19', x: 610, y: 1050, title: 'ç‡’è‚‰å¼˜å•†åº—', jpTitle: 'å¼˜å•†åº—', type: 'food', day: 4, rating: { tabelog: 3.46, google: 4.0 } },
  
  // --- Day 5 (è‹”ç¶ ) ---
  { id: 'm11', x: 520, y: 720, title: 'äºŒæ¢åŸ', jpTitle: 'äºŒæ¡åŸ', type: 'spot', day: 5, isLandmark: true }, 
  { id: 'm12', x: 480, y: 730, title: 'å–«èŒ¶ãƒãƒ­ãƒ«', jpTitle: 'ãƒãƒ­ãƒ«', type: 'coffee', day: 5, rating: { tabelog: 3.67, google: 4.1 } }, 
  
  // --- åœ°åœ–èƒŒæ™¯åœ°æ¨™ (Landmark) ---
  { id: 'x1', x: 250, y: 400, title: 'é‡‘é–£å¯º', jpTitle: 'é‡‘é–£å¯º', type: 'spot', day: null, isLandmark: true }, 
  { id: 'x2', x: 920, y: 650, title: 'å—ç¦ªå¯º', jpTitle: 'å—ç¦…å¯º', type: 'spot', day: null, isLandmark: true },
  { id: 'x3', x: 850, y: 600, title: 'å¹³å®‰ç¥å®®', jpTitle: 'å¹³å®‰ç¥å®®', type: 'spot', day: null, isLandmark: true },
  { id: 'x4', x: 350, y: 550, title: 'åŒ—é‡å¤©æ»¿å®®', jpTitle: 'åŒ—é‡å¤©æº€å®®', type: 'spot', day: null, isLandmark: true },
  { id: 'x5', x: 600, y: 600, title: 'äº¬éƒ½å¾¡è‹‘', jpTitle: 'äº¬éƒ½å¾¡è‹‘', type: 'spot', day: null, isLandmark: true },

  // --- æ–°å¢: æœªå®‰æ’è¡Œç¨‹çš„æ™¯é»/é¤å»³ (Day: null) ---
  { id: 'new1', x: 820, y: 840, title: 'ç¥‡åœ’ ç‰›ç¦…', jpTitle: 'ç¥‡åœ’ ç‰›ç¦…', type: 'food', day: null, rating: { tabelog: 3.45, google: 4.1 } }, 
  { id: 'new2', x: 810, y: 860, title: 'ç¥‡åœ’ NISHIMURAYA', jpTitle: 'ã«ã—ã‚€ã‚‰ã‚„', type: 'food', day: null, rating: { tabelog: 3.20, google: 4.3 } }, 
  { id: 'new3', x: 830, y: 820, title: 'æŒ½è‚‰èˆ‡ç±³ äº¬éƒ½', jpTitle: 'æŒ½è‚‰ã¨ç±³', type: 'food', day: null, rating: { tabelog: 3.60, google: 4.4 } }, 
  { id: 'new4', x: 740, y: 890, title: 'æœ¨æ‘å£½å–œç‡’', jpTitle: 'ã‚­ãƒ ãƒ©', type: 'food', day: null, rating: { tabelog: 3.58, google: 4.0 } }, 
  { id: 'new5', x: 860, y: 900, title: 'ç„¡é„°', jpTitle: 'ç„¡é„°', type: 'food', day: null, rating: { tabelog: 3.30, google: 3.8 } }, 
];

const INITIAL_INFO = {
  flight: {
    outbound: { 
      date: '2026/01/05', 
      time: '09:40 - 13:10', 
      boardingTime: '09:00',
      airline: 'æ¨‚æ¡ƒèˆªç©º MM024', 
      from: 'TPE (T1)', 
      to: 'KIX (T2)',
      gate: 'B6',
      seat: 'æœªåŠƒä½'
    },
    inbound: { 
      date: '2026/01/09', 
      time: '15:25 - 17:55', 
      boardingTime: '14:45',
      airline: 'æ¨‚æ¡ƒèˆªç©º MM027', 
      from: 'KIX (T2)', 
      to: 'TPE (T1)',
      gate: '--' ,
      seat: 'æœªåŠƒä½'
    },
  },
  accommodation: {
    name: 'The Royal Park Canvas Kyoto Nijo',
    address: 'äº¬éƒ½åºœäº¬éƒ½å¸‚ä¸­äº¬å€',
    note: 'Check-in: 15:00 / Check-out: 11:00'
  },
  budget: { total: 100000 } // TWD
};

const INITIAL_EXPENSES = [
  { id: 1, date: '2026/01/05', time: '14:30', amount: 3000, currency: 'JPY', name: 'Harukaè»Šç¥¨', category: 'äº¤é€š', payer: 'HongYi', split: 'split', note: 'å…©å¼µç¥¨' }
];

export default function App() {
  const [activeTab, setActiveTab] = useState('info');
  
  const [itinerary, setItinerary] = useState(() => {
    try { const s = localStorage.getItem('kyoto_itinerary'); return s ? JSON.parse(s) : INITIAL_ITINERARY; } catch(e) { return INITIAL_ITINERARY; }
  });
  
  const [markers, setMarkers] = useState(() => {
    try { const s = localStorage.getItem('kyoto_markers'); return s ? JSON.parse(s) : INITIAL_MARKERS; } catch(e) { return INITIAL_MARKERS; }
  });

  const [expenses, setExpenses] = useState(() => {
    try { const s = localStorage.getItem('kyoto_expenses'); return s ? JSON.parse(s) : []; } catch(e) { return []; }
  });
  
  const [infoData, setInfoData] = useState(() => {
    try { const s = localStorage.getItem('kyoto_info'); return s ? JSON.parse(s) : INITIAL_INFO; } catch(e) { return INITIAL_INFO; }
  });

  const [japaneseData, setJapaneseData] = useState(() => {
     try { const s = localStorage.getItem('kyoto_japanese'); return s ? JSON.parse(s) : INITIAL_JAPANESE_DATA; } catch(e) { return INITIAL_JAPANESE_DATA; }
  });

  useEffect(() => { localStorage.setItem('kyoto_itinerary', JSON.stringify(itinerary)); }, [itinerary]);
  useEffect(() => { localStorage.setItem('kyoto_markers', JSON.stringify(markers)); }, [markers]);
  useEffect(() => { localStorage.setItem('kyoto_expenses', JSON.stringify(expenses)); }, [expenses]);
  useEffect(() => { localStorage.setItem('kyoto_info', JSON.stringify(infoData)); }, [infoData]);
  useEffect(() => { localStorage.setItem('kyoto_japanese', JSON.stringify(japaneseData)); }, [japaneseData]);

  const renderContent = () => {
    switch (activeTab) {
      case 'itinerary': return <ItineraryView itinerary={itinerary} setItinerary={setItinerary} />;
      case 'map': return <MapView markers={markers} setMarkers={setMarkers} setItinerary={setItinerary} />;
      case 'finance': return <FinanceView expenses={expenses} setExpenses={setExpenses} />;
      case 'info': return <InfoView infoData={infoData} setInfoData={setInfoData} expenses={expenses} />;
      case 'language': return <LanguageView japaneseData={japaneseData} setJapaneseData={setJapaneseData} />;
      default: return <InfoView infoData={infoData} setInfoData={setInfoData} expenses={expenses} />;
    }
  };

  return (
    <>
    <style>{`
      @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;400;600;700&display=swap');
      body { font-family: 'Noto Serif TC', serif; -webkit-font-smoothing: antialiased; }
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      .font-noto { font-family: 'Noto Serif TC', serif; }
    `}</style>
    <div className={`w-full h-screen ${COLORS.bg} ${COLORS.text} font-noto overflow-hidden flex flex-col`}>
      <div className="flex-1 overflow-hidden relative">
        {renderContent()}
      </div>
      <div className="fixed bottom-0 w-full bg-white/95 backdrop-blur-md border-t border-[#E0E0E0] h-20 flex justify-around items-center pb-2 z-50 shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
        <NavButton icon={<List />} label="è¡Œç¨‹" active={activeTab === 'itinerary'} onClick={() => setActiveTab('itinerary')} />
        <NavButton icon={<Map />} label="åœ°åœ–" active={activeTab === 'map'} onClick={() => setActiveTab('map')} />
        <NavButton icon={<Wallet />} label="è¨˜å¸³" active={activeTab === 'finance'} onClick={() => setActiveTab('finance')} />
        <NavButton icon={<Info />} label="è³‡è¨Š" active={activeTab === 'info'} onClick={() => setActiveTab('info')} />
        <NavButton icon={<MessageCircle />} label="æ—¥èª" active={activeTab === 'language'} onClick={() => setActiveTab('language')} />
      </div>
    </div>
    </>
  );
}

// --- 4. è³‡è¨Šé é¢ (InfoView) ---
function InfoView({ infoData, setInfoData, expenses }) {
  const [isEditing, setIsEditing] = useState(false);
  const [tempData, setTempData] = useState(infoData);

  // åŒ¯ç‡ (ç”¨æ–¼é¡¯ç¤ºé ç®—)
  const RATE_JPY_TO_TWD = 0.22;

  // è¨ˆç®—å·²æ”¯å‡ºç¸½é¡ (TWD)
  const totalSpentTWD = useMemo(() => {
    return expenses.reduce((sum, ex) => {
        const amount = parseFloat(ex.amount);
        return sum + (ex.currency === 'JPY' ? amount * RATE_JPY_TO_TWD : amount);
    }, 0);
  }, [expenses]);

  const remainingBudget = infoData.budget.total - totalSpentTWD;
  const progress = Math.min(100, (totalSpentTWD / infoData.budget.total) * 100);

  const handleSave = () => {
    setInfoData(tempData);
    setIsEditing(false);
  };

  return (
    <div className="p-4 bg-[#F8F8F6] min-h-full pb-24 overflow-y-auto">
      <div className="flex justify-between items-center mb-6 px-2">
         <h1 className="text-2xl font-bold text-[#4A4A4A] tracking-widest">TRIP INFO</h1>
         <button onClick={() => { setTempData(infoData); setIsEditing(true); }} className="p-2 bg-white rounded-full shadow-sm text-gray-500 hover:text-[#A89F91]">
            <Edit2 size={18} />
         </button>
      </div>

      {/* é ç®—å„€è¡¨æ¿ */}
      <div className="bg-white p-5 rounded-3xl shadow-sm border border-gray-100 mb-5">
         <div className="flex items-center gap-2 mb-4 text-[#A89F91]">
            <PieChart size={20} />
            <h3 className="font-bold text-sm">é ç®—æ¦‚æ³ (TWD)</h3>
         </div>
         <div className="flex justify-between items-end mb-2">
             <div>
                 <p className="text-xs text-gray-400">ç¸½æ”¯å‡º</p>
                 <p className="text-2xl font-bold text-[#4A4A4A]">${Math.round(totalSpentTWD).toLocaleString()}</p>
             </div>
             <div className="text-right">
                 <p className="text-xs text-gray-400">å‰©é¤˜é ç®—</p>
                 <p className={`text-lg font-bold ${remainingBudget < 0 ? 'text-red-500' : 'text-green-600'}`}>
                    ${Math.round(remainingBudget).toLocaleString()}
                 </p>
             </div>
         </div>
         {/* é€²åº¦æ¢ */}
         <div className="h-2 w-full bg-gray-100 rounded-full overflow-hidden">
             <div className={`h-full rounded-full ${progress > 100 ? 'bg-red-400' : 'bg-[#A89F91]'}`} style={{ width: `${progress}%` }}></div>
         </div>
         <p className="text-[10px] text-gray-400 mt-2 text-right">ç¸½é ç®—è¨­å®š: ${infoData.budget.total.toLocaleString()}</p>
      </div>

      {/* èˆªç­è³‡è¨Š - æ–°å¢ Boarding, Gate, Seat */}
      <div className="bg-white p-5 rounded-3xl shadow-sm border border-gray-100 mb-5 relative overflow-hidden">
         <div className="absolute -right-4 -top-4 text-blue-50 opacity-50"><Plane size={100} /></div>
         <div className="flex items-center gap-2 mb-4 text-[#8FA3AD] relative z-10">
            <Plane size={20} />
            <h3 className="font-bold text-sm">èˆªç­è³‡è¨Š</h3>
         </div>
         
         {/* å»ç¨‹ */}
         <div className="mb-4 relative z-10">
            <div className="flex items-center justify-between mb-1">
                <span className="text-xs bg-[#8FA3AD] text-white px-2 py-0.5 rounded">å»ç¨‹</span>
                <span className="text-xs text-gray-400">{infoData.flight.outbound.date}</span>
            </div>
            <div className="bg-gray-50 p-3 rounded-xl border border-gray-100">
                <div className="flex justify-between items-center mb-2">
                    <div className="text-center">
                        <div className="text-xl font-bold text-gray-700">{infoData.flight.outbound.from.split(' ')[0]}</div>
                        <div className="text-[10px] text-gray-400">{infoData.flight.outbound.from.split(' ')[1]}</div>
                    </div>
                    <div className="flex flex-col items-center px-2">
                         <span className="text-[10px] text-gray-400 mb-0.5">{infoData.flight.outbound.airline.split(' ')[0]}</span>
                         <div className="h-[1px] w-12 bg-gray-300 relative">
                             <div className="absolute right-0 -top-1 w-2 h-2 rounded-full bg-gray-300"></div>
                         </div>
                         <span className="text-[10px] font-bold text-gray-600 mt-0.5">{infoData.flight.outbound.time}</span>
                    </div>
                    <div className="text-center">
                        <div className="text-xl font-bold text-gray-700">{infoData.flight.outbound.to.split(' ')[0]}</div>
                        <div className="text-[10px] text-gray-400">{infoData.flight.outbound.to.split(' ')[1]}</div>
                    </div>
                </div>
                {/* ç™»æ©Ÿè³‡è¨Šåˆ— */}
                <div className="flex justify-between border-t border-gray-200 pt-2 mt-2">
                    <div className="text-center">
                        <div className="text-[10px] text-gray-400">Boarding</div>
                        <div className="text-sm font-bold text-[#4A4A4A]">{infoData.flight.outbound.boardingTime}</div>
                    </div>
                    <div className="text-center">
                        <div className="text-[10px] text-gray-400">Gate</div>
                        <div className="text-sm font-bold text-[#4A4A4A]">{infoData.flight.outbound.gate}</div>
                    </div>
                    <div className="text-center">
                        <div className="text-[10px] text-gray-400">Seat</div>
                        <div className="text-sm font-bold text-[#4A4A4A]">{infoData.flight.outbound.seat}</div>
                    </div>
                </div>
            </div>
         </div>

         {/* å›ç¨‹ */}
         <div className="relative z-10">
            <div className="flex items-center justify-between mb-1">
                <span className="text-xs bg-[#D4A5A5] text-white px-2 py-0.5 rounded">å›ç¨‹</span>
                <span className="text-xs text-gray-400">{infoData.flight.inbound.date}</span>
            </div>
            <div className="bg-gray-50 p-3 rounded-xl border border-gray-100">
                <div className="flex justify-between items-center mb-2">
                    <div className="text-center">
                        <div className="text-xl font-bold text-gray-700">{infoData.flight.inbound.from.split(' ')[0]}</div>
                        <div className="text-[10px] text-gray-400">{infoData.flight.inbound.from.split(' ')[1]}</div>
                    </div>
                    <div className="flex flex-col items-center px-2">
                         <span className="text-[10px] text-gray-400 mb-0.5">{infoData.flight.inbound.airline.split(' ')[0]}</span>
                         <div className="h-[1px] w-12 bg-gray-300 relative">
                             <div className="absolute right-0 -top-1 w-2 h-2 rounded-full bg-gray-300"></div>
                         </div>
                         <span className="text-[10px] font-bold text-gray-600 mt-0.5">{infoData.flight.inbound.time}</span>
                    </div>
                    <div className="text-center">
                        <div className="text-xl font-bold text-gray-700">{infoData.flight.inbound.to.split(' ')[0]}</div>
                        <div className="text-[10px] text-gray-400">{infoData.flight.inbound.to.split(' ')[1]}</div>
                    </div>
                </div>
                {/* ç™»æ©Ÿè³‡è¨Šåˆ— */}
                <div className="flex justify-between border-t border-gray-200 pt-2 mt-2">
                    <div className="text-center">
                        <div className="text-[10px] text-gray-400">Boarding</div>
                        <div className="text-sm font-bold text-[#4A4A4A]">{infoData.flight.inbound.boardingTime}</div>
                    </div>
                    <div className="text-center">
                        <div className="text-[10px] text-gray-400">Gate</div>
                        <div className="text-sm font-bold text-[#4A4A4A]">{infoData.flight.inbound.gate}</div>
                    </div>
                    <div className="text-center">
                        <div className="text-[10px] text-gray-400">Seat</div>
                        <div className="text-sm font-bold text-[#4A4A4A]">{infoData.flight.inbound.seat}</div>
                    </div>
                </div>
            </div>
         </div>
      </div>

      {/* ä½å®¿è³‡è¨Š */}
      <div className="bg-white p-5 rounded-3xl shadow-sm border border-gray-100 mb-5">
         <div className="flex items-center gap-2 mb-3 text-[#7E8D75]">
            <Home size={20} />
            <h3 className="font-bold text-sm">ä½å®¿è³‡è¨Š</h3>
         </div>
         <h4 className="text-lg font-bold text-gray-800 mb-1">{infoData.accommodation.name}</h4>
         <p className="text-xs text-gray-500 mb-3 flex items-center gap-1"><MapPin size={12}/> {infoData.accommodation.address}</p>
         <div className="bg-[#F4F8F0] p-3 rounded-xl text-xs text-gray-600 border border-[#E3E8E1]">
             {infoData.accommodation.note}
         </div>
      </div>

      {/* ç·Šæ€¥è¯çµ¡ */}
      <div className="bg-[#FFF8F8] p-5 rounded-3xl shadow-sm border border-red-50">
         <div className="flex items-center gap-2 mb-4 text-red-400">
            <Phone size={20} />
            <h3 className="font-bold text-sm">ç·Šæ€¥è¯çµ¡</h3>
         </div>
         <div className="grid grid-cols-2 gap-3">
             <div className="bg-white p-3 rounded-xl text-center border border-red-50">
                 <div className="text-2xl font-bold text-red-500 font-noto">119</div>
                 <div className="text-[10px] text-gray-400">æ•‘è­·è»Š/ç«è­¦</div>
             </div>
             <div className="bg-white p-3 rounded-xl text-center border border-red-50">
                 <div className="text-2xl font-bold text-red-500 font-noto">110</div>
                 <div className="text-[10px] text-gray-400">è­¦å¯Ÿå±€</div>
             </div>
         </div>
      </div>

      {/* ç·¨è¼¯ Modal */}
      {isEditing && (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl max-h-[80vh] overflow-y-auto">
                <h3 className="font-bold text-lg mb-4 text-center">ç·¨è¼¯è³‡è¨Š</h3>
                
                {/* é ç®— */}
                <div className="mb-4">
                    <label className="text-xs text-gray-400 block mb-1">ç¸½é ç®— (TWD)</label>
                    <input className="w-full p-2 bg-gray-50 rounded border" type="number" 
                        value={tempData.budget.total} 
                        onChange={e => setTempData({...tempData, budget: { ...tempData.budget, total: parseInt(e.target.value) }})} />
                </div>

                {/* èˆªç­ç´°ç¯€ (å»ç¨‹) */}
                <div className="mb-4 p-3 bg-gray-50 rounded-xl border">
                    <p className="text-xs font-bold mb-2">å»ç¨‹èˆªç­</p>
                    <div className="grid grid-cols-2 gap-2">
                        <input className="p-2 rounded border text-xs" placeholder="ç™»æ©Ÿæ™‚é–“" value={tempData.flight.outbound.boardingTime} onChange={e => setTempData({...tempData, flight: {...tempData.flight, outbound: {...tempData.flight.outbound, boardingTime: e.target.value}}})} />
                        <input className="p-2 rounded border text-xs" placeholder="ç™»æ©Ÿé–€" value={tempData.flight.outbound.gate} onChange={e => setTempData({...tempData, flight: {...tempData.flight, outbound: {...tempData.flight.outbound, gate: e.target.value}}})} />
                        <input className="p-2 rounded border text-xs col-span-2" placeholder="åº§ä½ (ä¾‹: 12A, 12B)" value={tempData.flight.outbound.seat} onChange={e => setTempData({...tempData, flight: {...tempData.flight, outbound: {...tempData.flight.outbound, seat: e.target.value}}})} />
                    </div>
                </div>

                 {/* èˆªç­ç´°ç¯€ (å›ç¨‹) */}
                 <div className="mb-4 p-3 bg-gray-50 rounded-xl border">
                    <p className="text-xs font-bold mb-2">å›ç¨‹èˆªç­</p>
                    <div className="grid grid-cols-2 gap-2">
                        <input className="p-2 rounded border text-xs" placeholder="ç™»æ©Ÿæ™‚é–“" value={tempData.flight.inbound.boardingTime} onChange={e => setTempData({...tempData, flight: {...tempData.flight, inbound: {...tempData.flight.inbound, boardingTime: e.target.value}}})} />
                        <input className="p-2 rounded border text-xs" placeholder="ç™»æ©Ÿé–€" value={tempData.flight.inbound.gate} onChange={e => setTempData({...tempData, flight: {...tempData.flight, inbound: {...tempData.flight.inbound, gate: e.target.value}}})} />
                        <input className="p-2 rounded border text-xs col-span-2" placeholder="åº§ä½" value={tempData.flight.inbound.seat} onChange={e => setTempData({...tempData, flight: {...tempData.flight, inbound: {...tempData.flight.inbound, seat: e.target.value}}})} />
                    </div>
                </div>

                {/* ä½å®¿ */}
                <div className="mb-4">
                    <label className="text-xs text-gray-400 block mb-1">ä½å®¿åç¨±</label>
                    <input className="w-full p-2 bg-gray-50 rounded border mb-2" 
                        value={tempData.accommodation.name} 
                        onChange={e => setTempData({...tempData, accommodation: { ...tempData.accommodation, name: e.target.value }})} />
                     <label className="text-xs text-gray-400 block mb-1">å‚™è¨» (Check-in/out)</label>
                    <textarea className="w-full p-2 bg-gray-50 rounded border" 
                        value={tempData.accommodation.note} 
                        onChange={e => setTempData({...tempData, accommodation: { ...tempData.accommodation, note: e.target.value }})} />
                </div>

                <div className="flex gap-2">
                    <button onClick={() => setIsEditing(false)} className="flex-1 py-3 text-gray-500 bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                    <button onClick={handleSave} className="flex-1 py-3 text-white bg-[#A89F91] rounded-xl font-bold">å„²å­˜</button>
                </div>
            </div>
        </div>
      )}
    </div>
  );
}

// --- 5. æ—¥èªé é¢ (LanguageView) ---
function LanguageView({ japaneseData, setJapaneseData }) {
  const [activeTab, setActiveTab] = useState('conversation'); 
  const [activeCategory, setActiveCategory] = useState('å…¨éƒ¨');
  const [isAdding, setIsAdding] = useState(false);

  const categories = ['å…¨éƒ¨', 'äº¤é€š', 'é¤å»³', 'è³¼ç‰©', 'ç·Šæ€¥'];

  const filteredData = useMemo(() => {
    return japaneseData.filter(item => {
        const typeMatch = activeTab === 'conversation' ? item.type === 'conversation' : item.type === 'vocabulary';
        const catMatch = activeCategory === 'å…¨éƒ¨' || item.category === activeCategory;
        return typeMatch && catMatch;
    });
  }, [activeTab, activeCategory, japaneseData]);

  const speak = (text) => {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'ja-JP';
    window.speechSynthesis.speak(utterance);
  };

  const handleAdd = (newItem) => {
      setJapaneseData(prev => [...prev, { ...newItem, id: Date.now() }]);
      setIsAdding(false);
  };

  return (
    <div className="p-4 bg-[#F8F8F6] min-h-full pb-24 overflow-y-auto">
      <div className="flex justify-between items-end mb-6 px-2">
          <h1 className="text-2xl font-bold text-[#4A4A4A] tracking-widest">æ—¥æœ¬èª</h1>
          <Languages size={24} className="text-[#A89F91]" />
      </div>

      <div className="flex bg-white p-1 rounded-xl mb-4 shadow-sm">
          <button 
            onClick={() => setActiveTab('conversation')}
            className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${activeTab==='conversation' ? 'bg-[#4A4A4A] text-white shadow' : 'text-gray-400'}`}>
            æœƒè©±ç¯‡
          </button>
          <button 
            onClick={() => setActiveTab('vocabulary')}
            className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${activeTab==='vocabulary' ? 'bg-[#4A4A4A] text-white shadow' : 'text-gray-400'}`}>
            å–®å­—ç¯‡
          </button>
      </div>

      <div className="flex gap-2 overflow-x-auto pb-4 no-scrollbar mb-2">
          {categories.map(cat => (
              <button key={cat} onClick={() => setActiveCategory(cat)}
                className={`flex-shrink-0 px-4 py-1.5 rounded-full text-xs font-bold border transition-all 
                ${activeCategory===cat ? 'bg-[#A89F91] text-white border-[#A89F91]' : 'bg-white text-gray-500 border-gray-200'}`}>
                {cat}
              </button>
          ))}
      </div>

      <div className="space-y-3">
          {filteredData.map(item => (
              <div key={item.id} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-50 flex items-start gap-3 active:scale-[0.99] transition-transform"
                   onClick={() => speak(item.jp)}>
                  <button className="mt-1 w-10 h-10 rounded-full bg-[#F4F4F0] flex items-center justify-center text-[#A89F91] flex-shrink-0">
                      <Volume2 size={20} />
                  </button>
                  <div className="flex-1">
                      <div className="flex justify-between">
                          <span className="text-[10px] bg-gray-100 text-gray-400 px-2 py-0.5 rounded-md mb-1 inline-block">{item.category}</span>
                      </div>
                      <p className="text-lg font-bold text-gray-800 leading-snug">{item.jp}</p>
                      <p className="text-xs text-gray-400 font-serif italic mb-1">{item.romaji}</p>
                      <p className="text-sm text-[#5D707A] font-medium">{item.cn}</p>
                  </div>
              </div>
          ))}
          {filteredData.length === 0 && <div className="text-center text-gray-400 py-10">æ­¤åˆ†é¡ç„¡è³‡æ–™</div>}
      </div>

      {/* æ–°å¢æŒ‰éˆ• */}
      <button onClick={() => setIsAdding(true)} className="fixed bottom-24 right-6 w-14 h-14 rounded-full bg-[#A89F91] text-white flex items-center justify-center shadow-xl hover:bg-[#968c7e] transition-all z-40 active:scale-95">
        <Plus size={24} />
      </button>

      {isAdding && <AddJapaneseModal onClose={() => setIsAdding(false)} onAdd={handleAdd} />}
    </div>
  );
}

const AddJapaneseModal = ({ onClose, onAdd }) => {
    const [form, setForm] = useState({ category: 'äº¤é€š', type: 'conversation', jp: '', romaji: '', cn: '' });

    return (
        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-4">
            <div className="bg-white w-full max-w-sm rounded-3xl p-6 animate-slide-up shadow-2xl">
                <h3 className="text-lg font-bold mb-4 text-[#4A4A4A]">æ–°å¢æ—¥èª</h3>
                
                <div className="flex gap-2 mb-3">
                    <select className="flex-1 p-3 bg-gray-50 rounded-xl border border-gray-100 outline-none text-sm"
                        value={form.type} onChange={e => setForm({...form, type: e.target.value})}>
                        <option value="conversation">æœƒè©±</option>
                        <option value="vocabulary">å–®å­—</option>
                    </select>
                    <select className="flex-1 p-3 bg-gray-50 rounded-xl border border-gray-100 outline-none text-sm"
                        value={form.category} onChange={e => setForm({...form, category: e.target.value})}>
                        <option>äº¤é€š</option><option>é¤å»³</option><option>è³¼ç‰©</option><option>ç·Šæ€¥</option>
                    </select>
                </div>

                <input className="w-full p-3 bg-gray-50 rounded-xl mb-2 border border-gray-100 outline-none" 
                    placeholder="æ—¥æ–‡ (ä¾‹å¦‚: ã“ã‚“ã«ã¡ã¯)" value={form.jp} onChange={e => setForm({...form, jp: e.target.value})} />
                <input className="w-full p-3 bg-gray-50 rounded-xl mb-2 border border-gray-100 outline-none" 
                    placeholder="ç¾…é¦¬æ‹¼éŸ³ (ä¾‹å¦‚: Konnichiwa)" value={form.romaji} onChange={e => setForm({...form, romaji: e.target.value})} />
                <input className="w-full p-3 bg-gray-50 rounded-xl mb-4 border border-gray-100 outline-none" 
                    placeholder="ä¸­æ–‡æ„æ€" value={form.cn} onChange={e => setForm({...form, cn: e.target.value})} />

                <button onClick={() => { if(form.jp) onAdd(form); }} className="w-full bg-[#4A4A4A] text-white py-3 rounded-xl font-bold shadow-md hover:bg-[#333]">æ–°å¢</button>
                <button onClick={onClose} className="w-full py-3 mt-2 text-gray-400">å–æ¶ˆ</button>
            </div>
        </div>
    );
};

// --- MapContent, MapView, KyotoMapSVG, ItineraryView ç­‰å…¶ä»–çµ„ä»¶ä¿æŒä¸è®Š ---

const MapContent = React.memo(({ zoom, markers, selectedMarkerId, onMarkerClick }) => {
    return (
        <>
        <KyotoMapSVG zoom={zoom} />
        {markers.map(m => {
             const style = TYPE_STYLES[m.type] || TYPE_STYLES.default;
             const scaleFactor = 1 / Math.sqrt(zoom); 
    
             // èƒŒæ™¯åœ°æ¨™ (Landmark) - ç´”å±•ç¤ºï¼Œç„¡äº’å‹•
             if (m.isLandmark) {
                 return (
                   <div 
                     key={m.id}
                     className="absolute flex flex-col items-center justify-center pointer-events-none"
                     style={{ 
                       left: m.x, top: m.y, 
                       transform: `translate(-50%, -50%) scale(${scaleFactor})`,
                       zIndex: 5,
                       willChange: 'transform'
                     }} 
                   >
                     <div className="flex flex-col items-center">
                         <span className="text-3xl filter drop-shadow-sm opacity-90 grayscale-[0.3]">
                             {style.emoji}
                         </span>
                         <span className="mt-1 text-[13px] font-bold text-[#5D4037] bg-white/40 backdrop-blur-[1px] px-1 rounded font-noto tracking-wider border border-[#8D6E63]/20 leading-tight">
                             {m.jpTitle}
                         </span>
                     </div>
                   </div>
                 );
             }
    
             // ä¸€èˆ¬è¡Œç¨‹æ™¯é» - å¯äº’å‹•
             // è‹¥æœ‰åˆ†é… Day å‰‡é¡¯ç¤ºé¡è‰²ï¼Œå¦å‰‡é¡¯ç¤ºç™½è‰²èƒŒæ™¯
             const hasDay = m.day && DAY_COLORS[m.day];
             const bgColor = hasDay ? DAY_COLORS[m.day] : 'white';
             const borderColor = hasDay ? 'white' : '#CCC'; // æœªåˆ†é…çš„çµ¦å€‹ç°æ¡†
    
             return (
               <div 
                 key={m.id}
                 className="absolute flex flex-col items-center justify-center cursor-pointer pointer-events-auto"
                 style={{ 
                   left: m.x, top: m.y, 
                   transform: `translate(-50%, -50%) scale(${scaleFactor})`,
                   zIndex: selectedMarkerId === m.id ? 100 : 10,
                   willChange: 'transform'
                 }} 
                 onClick={(e) => { e.stopPropagation(); onMarkerClick(m); }}
               >
                 {/* åœ“å½¢èƒŒæ™¯æ¨™è¨˜ */}
                 <div className="relative rounded-full shadow-md flex items-center justify-center w-[28px] h-[28px] border-[1.5px] transition-transform hover:scale-110 active:scale-95"
                      style={{ backgroundColor: bgColor, borderColor: borderColor }}>
                   <span className="text-[14px] leading-none filter drop-shadow-sm">{style.emoji}</span>
                 </div>
                 
                 {/* æ–‡å­—æ¨™ç±¤ (ç¸®æ”¾ > 1.25 æ‰é¡¯ç¤º) */}
                 {zoom > 1.25 && (
                   <div className="absolute left-[110%] top-1/2 -translate-y-1/2 flex flex-col bg-white/70 backdrop-blur-[2px] px-1.5 py-0.5 rounded shadow-sm pointer-events-none border border-white/40">
                     <span className="text-[12px] font-bold whitespace-nowrap leading-none font-noto tracking-wide" style={{color: hasDay ? DAY_TEXT_COLORS[m.day] : '#999'}}>
                       {m.title}
                     </span>
                   </div>
                 )}
               </div>
             );
          })}
        </>
      );
});

function MapView({ markers, setMarkers, setItinerary }) {
     const containerRef = useRef(null);
     const MAP_WIDTH = 1200;
     const MAP_HEIGHT = 1600;
     
     const [transform, setTransform] = useState({ x: 0, y: 0, scale: 0.8 });
     const [selectedMarker, setSelectedMarker] = useState(null);
     const [filterType, setFilterType] = useState(null);
     const [isDragging, setIsDragging] = useState(false);
     
     const [editingMarker, setEditingMarker] = useState(null);
     const [isAdding, setIsAdding] = useState(false);
     const [clickPos, setClickPos] = useState(null);
   
     const lastPos = useRef({ x: 0, y: 0 });
   
     const centerMap = useCallback(() => {
       if (!containerRef.current) return;
       const { clientWidth, clientHeight } = containerRef.current;
       const targetScale = 0.8;
       const mapCenterX = 600;
       const mapCenterY = 800;
       const targetX = (clientWidth / 2) - (mapCenterX * targetScale);
       const targetY = (clientHeight / 2) - (mapCenterY * targetScale);
       setTransform({ x: targetX, y: targetY, scale: targetScale });
     }, []);
   
     useEffect(() => {
       centerMap();
       window.addEventListener('resize', centerMap);
       return () => window.removeEventListener('resize', centerMap);
     }, [centerMap]);
     
     const handlePointerDown = (e) => {
       e.preventDefault(); 
       setIsDragging(true);
       lastPos.current = { x: e.clientX, y: e.clientY };
     };
   
     const handlePointerMove = (e) => {
       if (!isDragging || !containerRef.current) return;
       e.preventDefault(); 
       const dx = e.clientX - lastPos.current.x;
       const dy = e.clientY - lastPos.current.y;
       lastPos.current = { x: e.clientX, y: e.clientY };
       const viewportW = containerRef.current.clientWidth;
       const viewportH = containerRef.current.clientHeight;
       setTransform(prev => {
         let newX = prev.x + dx;
         let newY = prev.y + dy;
         const minX = viewportW - (MAP_WIDTH * prev.scale);
         const maxX = 0;
         const minY = viewportH - (MAP_HEIGHT * prev.scale);
         const maxY = 0;
         if (newX > maxX + 50) newX = maxX + 50;
         if (newX < minX - 50) newX = minX - 50;
         if (newY > maxY + 50) newY = maxY + 50;
         if (newY < minY - 50) newY = minY - 50;
         return { ...prev, x: newX, y: newY };
       });
     };
   
     const handlePointerUp = () => setIsDragging(false);
   
     const handleZoom = (delta) => {
       setTransform(prev => {
         const newScale = Math.min(Math.max(0.5, prev.scale + delta), 3);
         return { ...prev, scale: newScale };
       });
     };
   
     const flyToMarker = useCallback((marker) => {
       if (!containerRef.current) return;
       const { clientWidth, clientHeight } = containerRef.current;
       const targetScale = 1.3;
       const targetX = Math.min(0, Math.max(clientWidth - MAP_WIDTH*targetScale, (clientWidth / 2) - (marker.x * targetScale)));
       const targetY = Math.min(0, Math.max(clientHeight - MAP_HEIGHT*targetScale, (clientHeight / 2) - (marker.y * targetScale)));
       setTransform({ x: targetX, y: targetY, scale: targetScale });
       setSelectedMarker(marker);
       setFilterType(null);
     }, []);
   
     const filteredMarkers = useMemo(() => filterType 
       ? markers.filter(m => {
           if (filterType === 'food') return ['food', 'dessert', 'coffee', 'bread'].includes(m.type);
           return m.type === filterType;
         })
       : markers, [markers, filterType]);
   
     const saveMarker = (data) => {
       const isNew = isAdding;
       let newMarker = null;
   
       if (isNew) {
         newMarker = { ...data, id: `u-${Date.now()}`, x: clickPos ? clickPos.x : 600, y: clickPos ? clickPos.y : 800 };
         setMarkers(prev => [...prev, newMarker]);
       } else {
         newMarker = data;
         setMarkers(prev => prev.map(m => m.id === data.id ? { ...m, ...data } : m));
       }
   
       // é€£å‹•è¡Œç¨‹é‚è¼¯ï¼šè‹¥æœ‰æŒ‡å®šå¤©æ•¸ï¼Œå‰‡æ–°å¢è‡³è¡Œç¨‹
       if (isNew && data.day) {
           setItinerary(prev => [
               ...prev,
               {
                   id: `i-${Date.now()}`,
                   day: parseInt(data.day),
                   time: '12:00', 
                   type: data.type,
                   title: data.title || data.jpTitle,
                   desc: 'å¾åœ°åœ–æ–°å¢çš„åœ°é»',
                   highlight: []
               }
           ]);
           alert(`å·²å°‡ã€Œ${data.title || data.jpTitle}ã€æ–°å¢è‡³ Day ${data.day} çš„è¡Œç¨‹ï¼`);
       }
   
       setEditingMarker(null);
       setIsAdding(false);
     };
     
     const deleteMarker = (id) => {
         if(window.confirm("ç¢ºå®šåˆªé™¤æ­¤åœ°æ¨™ï¼Ÿ")) {
             setMarkers(prev => prev.filter(m => m.id !== id));
             setSelectedMarker(null);
         }
     };
   
     return (
       <div className={`relative w-full h-full bg-[#f4f4f0] overflow-hidden select-none ${isDragging ? 'cursor-grabbing' : 'cursor-grab'}`}
            ref={containerRef}
            onPointerDown={handlePointerDown}
            onPointerMove={handlePointerMove}
            onPointerUp={handlePointerUp}
            onPointerLeave={handlePointerUp}
            style={{ touchAction: 'none' }}
       >
         <div className="absolute top-24 right-4 z-30 flex flex-col gap-3 pointer-events-auto">
           <button onClick={centerMap} className="bg-white/90 backdrop-blur w-10 h-10 rounded-full shadow-md text-gray-600 flex items-center justify-center active:scale-95 transition-transform" title="é‡ç½®åœ°åœ–">
               <RotateCcw size={18} />
           </button>
           <button onClick={() => handleZoom(0.3)} className="bg-white/90 backdrop-blur w-10 h-10 rounded-full shadow-md text-gray-600 flex items-center justify-center text-xl font-bold active:scale-95 transition-transform">+</button>
           <button onClick={() => handleZoom(-0.3)} className="bg-white/90 backdrop-blur w-10 h-10 rounded-full shadow-md text-gray-600 flex items-center justify-center text-xl font-bold active:scale-95 transition-transform">-</button>
           <button onClick={() => { setIsAdding(true); setClickPos({x:600, y:800}); }} className="bg-[#A89F91] text-white w-10 h-10 rounded-full shadow-md flex items-center justify-center active:scale-95 transition-transform"><Plus size={20}/></button>
         </div>
   
         <div 
           style={{ 
             transform: `translate(${transform.x}px, ${transform.y}px) scale(${transform.scale})`, 
             transformOrigin: '0 0',
             width: MAP_WIDTH, height: MAP_HEIGHT,
             willChange: 'transform',
             transition: isDragging ? 'none' : 'transform 0.1s ease-out'
           }}
           className="relative bg-[#f4f4f0] shadow-xl"
         >
           <MapContent 
               zoom={transform.scale} 
               markers={filterType ? filteredMarkers : markers} 
               selectedMarkerId={selectedMarker?.id}
               onMarkerClick={setSelectedMarker}
           />
   
           {selectedMarker && !selectedMarker.isLandmark && (
             <div 
               className="absolute z-[150] p-4 rounded-2xl backdrop-blur-xl bg-white/90 shadow-[0_8px_30px_rgba(0,0,0,0.15)] border border-white/60 w-64 animate-bounce-in origin-bottom cursor-default pointer-events-auto"
               style={{ 
                 left: selectedMarker.x, 
                 top: selectedMarker.y - 35, 
                 transform: `translate(-50%, -100%) scale(${1 / transform.scale})` 
               }}
               onPointerDown={e => e.stopPropagation()}
             >
                <div className="flex justify-between items-start mb-2">
                   <div>
                       <h4 className="font-bold text-gray-800 text-lg font-noto leading-tight">{selectedMarker.jpTitle}</h4>
                       <p className="text-xs text-gray-500 mt-1">{selectedMarker.title}</p>
                   </div>
                   <div className="flex gap-1 bg-gray-100 rounded-lg p-0.5">
                       <button onClick={() => { setEditingMarker(selectedMarker); setIsAdding(false); }} className="p-1.5 text-gray-400 hover:text-blue-500 rounded"><Edit2 size={12}/></button>
                       <button onClick={() => setSelectedMarker(null)} className="p-1.5 text-gray-400 hover:text-gray-600 rounded"><X size={14}/></button>
                   </div>
                </div>
                
                {['food', 'dessert', 'coffee', 'bread'].includes(selectedMarker.type) && selectedMarker.rating && (
                    <div className="flex gap-2 mb-3">
                        <div className="flex items-center gap-1 bg-orange-50 px-2 py-1 rounded-md border border-orange-100">
                            <span className="text-[10px] font-bold text-orange-400">Tabelog</span>
                            <span className="text-sm font-bold text-orange-600">{selectedMarker.rating.tabelog}</span>
                        </div>
                        <div className="flex items-center gap-1 bg-blue-50 px-2 py-1 rounded-md border border-blue-100">
                            <span className="text-[10px] font-bold text-blue-400">Google</span>
                            <span className="text-sm font-bold text-blue-600">{selectedMarker.rating.google}</span>
                        </div>
                    </div>
                )}
   
                <div className="flex items-center gap-2 mb-3">
                   {selectedMarker.day && DAY_COLORS[selectedMarker.day] ? (
                       <span className="w-2.5 h-2.5 rounded-full" style={{background: DAY_COLORS[selectedMarker.day]}}></span>
                   ) : (
                       <span className="w-2.5 h-2.5 rounded-full border border-gray-300 bg-white"></span>
                   )}
                   
                   <span className="text-xs text-gray-500 font-bold">
                       {selectedMarker.day ? `Day ${selectedMarker.day}` : 'æœªå®‰æ’'}
                   </span>
                   <span className="text-xs bg-gray-100 px-2 py-0.5 rounded-full text-gray-500">{TYPE_STYLES[selectedMarker.type]?.label}</span>
                </div>
                <div className="flex gap-2">
                   <a href={selectedMarker.link || `https://www.google.com/maps/search/?api=1&query=${selectedMarker.jpTitle} äº¬éƒ½`} target="_blank" rel="noreferrer"
                      className="flex-1 flex items-center justify-center gap-1 text-xs bg-[#4A4A4A] text-white py-2 rounded-xl font-bold hover:bg-[#333] shadow-sm">
                      <Navigation size={12} /> Google Maps
                   </a>
                   <button onClick={() => deleteMarker(selectedMarker.id)} className="px-3 bg-red-50 text-red-400 rounded-xl hover:bg-red-100 border border-red-100"><Trash2 size={14}/></button>
                </div>
                <div className="absolute bottom-[-8px] left-1/2 -translate-x-1/2 w-4 h-4 bg-white/90 backdrop-blur-xl rotate-45 transform border-r border-b border-white/60"></div>
             </div>
           )}
         </div>
   
         <div className="absolute bottom-24 left-0 w-full px-4 flex gap-3 overflow-x-auto pb-4 z-40 no-scrollbar pointer-events-auto">
            {['coffee', 'bread', 'food', 'dessert', 'shopping', 'spot'].map(type => (
                <FilterButton key={type} type={type} label={TYPE_STYLES[type].label} active={filterType===type} onClick={()=>setFilterType(filterType===type?null:type)} />
            ))}
         </div>
   
         {filterType && (
           <div className="absolute bottom-0 left-0 w-full bg-white rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.1)] z-50 max-h-[50vh] overflow-y-auto pb-24 animate-slide-up pointer-events-auto"
                onPointerDown={e => e.stopPropagation()}
           >
              <div className="sticky top-0 bg-white/95 backdrop-blur p-4 flex justify-between items-center border-b border-gray-100 z-10">
                <h3 className="font-bold text-gray-700 text-lg flex items-center gap-2 font-noto">
                   {TYPE_STYLES[filterType]?.emoji} ç²¾é¸{TYPE_STYLES[filterType]?.label}
                </h3>
                <button onClick={() => setFilterType(null)} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200"><X size={18} /></button>
              </div>
              <div className="p-2 space-y-1">
                {filteredMarkers.map(m => (
                  <div key={m.id} onClick={() => flyToMarker(m)} className="flex items-center gap-4 p-4 hover:bg-[#F8F8F6] rounded-2xl cursor-pointer transition-colors border border-transparent hover:border-gray-100">
                    <span className="text-2xl w-12 h-12 flex items-center justify-center bg-gray-50 rounded-full shadow-sm" style={{backgroundColor: m.day ? DAY_COLORS[m.day] : '#EEE'}}>{TYPE_STYLES[m.type]?.emoji}</span>
                    <div className="flex-1">
                      <div className="font-bold text-gray-800 text-base font-noto">{m.jpTitle}</div>
                      <div className="text-xs text-gray-400 mt-1 flex items-center gap-2">
                         <span className="text-gray-500">{m.title}</span>
                         <span className="flex items-center gap-1 bg-gray-100 px-1.5 py-0.5 rounded">
                             {m.day ? <span className="w-1.5 h-1.5 rounded-full" style={{background: DAY_COLORS[m.day]}}></span> : null}
                             {m.day ? `Day ${m.day}` : 'æœªå®‰æ’'}
                         </span>
                      </div>
                    </div>
                    <div className="w-8 h-8 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center"><ArrowRight size={16}/></div>
                  </div>
                ))}
                {filteredMarkers.length === 0 && <div className="p-10 text-center text-gray-400">æ²’æœ‰ç¬¦åˆçš„åœ°é»</div>}
              </div>
           </div>
         )}
   
         {(editingMarker || isAdding) && (
           <div className="absolute inset-0 z-[70] bg-black/30 backdrop-blur-sm flex items-center justify-center p-4 pointer-events-auto" onClick={() => {setEditingMarker(null); setIsAdding(false);}}>
               <div className="bg-white p-6 rounded-3xl w-full max-w-xs shadow-2xl animate-bounce-in" onClick={e=>e.stopPropagation()}>
                   <h3 className="font-bold text-gray-800 mb-4 text-center font-noto">{isAdding ? 'æ–°å¢åœ°æ¨™' : 'ç·¨è¼¯åœ°æ¨™'}</h3>
                   <input className="w-full bg-gray-50 p-3 rounded-xl border border-gray-100 mb-2 outline-none font-noto" placeholder="æ—¥æ–‡åç¨± (å¿…è¦)" value={editingMarker?.jpTitle || ''} onChange={e => setEditingMarker({...editingMarker, jpTitle: e.target.value})} />
                   <input className="w-full bg-gray-50 p-3 rounded-xl border border-gray-100 mb-4 outline-none" placeholder="ä¸­æ–‡åç¨± (é¸å¡«)" value={editingMarker?.title || ''} onChange={e => setEditingMarker({...editingMarker, title: e.target.value})} />
                   
                   <div className="mb-4">
                       <label className="text-xs text-gray-400 block mb-1">è¡Œç¨‹å®‰æ’ (Day)</label>
                       <select
                           className="w-full bg-gray-50 p-3 rounded-xl border border-gray-100 mb-2 outline-none"
                           value={editingMarker?.day || ''}
                           onChange={e => setEditingMarker({...editingMarker, day: e.target.value ? parseInt(e.target.value) : null})}
                       >
                           <option value="">æœªå®‰æ’ (ç„¡èƒŒæ™¯è‰²)</option>
                           <option value="1">Day 1 (1/5)</option>
                           <option value="2">Day 2 (1/6)</option>
                           <option value="3">Day 3 (1/7)</option>
                           <option value="4">Day 4 (1/8)</option>
                           <option value="5">Day 5 (1/9)</option>
                       </select>
                   </div>
   
                   <div className="grid grid-cols-4 gap-2 mb-4">
                       {Object.keys(TYPE_STYLES).filter(k=>k!=='default').map(key => (
                           <button key={key} onClick={() => setEditingMarker({...editingMarker, type: key})}
                                   className={`p-2 rounded-xl border flex flex-col items-center gap-1 transition-all ${editingMarker?.type === key ? 'bg-[#F4F4F0] border-[#A89F91] scale-105 shadow-sm' : 'border-transparent hover:bg-gray-50'}`}>
                               <span className="text-xl">{TYPE_STYLES[key].emoji}</span>
                           </button>
                       ))}
                   </div>
                   <button onClick={() => saveMarker(editingMarker)} className="w-full bg-[#4A4A4A] text-white py-3 rounded-xl font-bold shadow-md hover:bg-[#333]">å„²å­˜</button>
               </div>
           </div>
         )}
       </div>
     );
}
function FinanceView({ expenses, setExpenses }) { 
    const [showAdd, setShowAdd] = useState(false);
      const RATE_JPY_TO_TWD = 0.22;
      const RATE_TWD_TO_JPY = 1 / RATE_JPY_TO_TWD;
    
      const summary = useMemo(() => {
        let totalTWD = 0;
        let totalJPY = 0;
        let debt = 0; 
    
        expenses.forEach(ex => {
          const amount = parseFloat(ex.amount);
          const isJPY = ex.currency === 'JPY';
          if (isJPY) { totalJPY += amount; totalTWD += amount * RATE_JPY_TO_TWD; } else { totalTWD += amount; totalJPY += amount * RATE_TWD_TO_JPY; }
          const amountInTWD = isJPY ? amount * RATE_JPY_TO_TWD : amount;
          let shareAmount = 0; 
          if (ex.split === 'split') { shareAmount = amountInTWD / 2; } else if (ex.split === 'HongYi') { shareAmount = amountInTWD; } else if (ex.split === 'YuTing') { shareAmount = amountInTWD; } else { shareAmount = amountInTWD / 2; }
          if (ex.payer === 'YuTing') { if (ex.split === 'split') debt += shareAmount; if (ex.split === 'HongYi') debt += amountInTWD; } else { if (ex.split === 'split') debt -= shareAmount; if (ex.split === 'YuTing') debt -= amountInTWD; }
        });
        return { totalTWD, totalJPY, debt };
      }, [expenses]);
    
      const handleAdd = (data) => { setExpenses(prev => [...prev, { ...data, id: Date.now() }]); setShowAdd(false); };
      const handleDelete = (id) => { if (window.confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†è¨˜å¸³ï¼Ÿ")) { setExpenses(prev => prev.filter(e => e.id !== id)); } };
    
      const groupedExpenses = useMemo(() => {
        const groups = {};
        expenses.forEach(ex => { if (!groups[ex.date]) groups[ex.date] = []; groups[ex.date].push(ex); });
        return Object.keys(groups).sort((a,b) => new Date(b) - new Date(a)).map(date => ({ date, items: groups[date].sort((a,b) => b.time.localeCompare(a.time)) }));
      }, [expenses]);
    
      return (
        <div className="p-4 bg-[#F8F8F6] min-h-full pb-24 overflow-y-auto h-full">
          <div className="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 mb-6 relative overflow-hidden">
            <div className="relative z-10">
                <h2 className="text-gray-400 text-xs font-bold tracking-widest mb-4">TOTAL EXPENSES</h2>
                <div className="flex justify-between items-end mb-6">
                  <div>
                    <div className="flex items-baseline gap-1">
                        <span className="text-sm font-bold text-gray-400">TWD</span>
                        <span className="text-3xl font-bold text-[#4A4A4A] font-noto tracking-tight">${Math.round(summary.totalTWD).toLocaleString()}</span>
                    </div>
                    <div className="text-xs text-gray-400 mt-1">(ç´„ JPY Â¥{Math.round(summary.totalJPY).toLocaleString()})</div>
                  </div>
                </div>
                <div className="bg-[#F8F8F6] rounded-xl p-4 flex items-center justify-between border border-gray-200">
                  <div className="flex items-center gap-2"><Calculator size={18} className="text-gray-400" /><span className="text-sm font-bold text-gray-600">çµç®—</span></div>
                  <div className={`text-sm px-3 py-1.5 rounded-lg font-bold flex items-center gap-2 ${summary.debt > 0 ? 'bg-[#EBF5FB] text-[#2E86C1]' : summary.debt < 0 ? 'bg-[#FDEDEC] text-[#C0392B]' : 'bg-gray-100 text-gray-500'}`}>
                    {Math.round(summary.debt) === 0 ? 'ç›®å‰çµæ¸…' : summary.debt > 0 ? <span>å®ä¸€ æ‡‰ä»˜ <span className="text-lg">${Math.abs(Math.round(summary.debt)).toLocaleString()}</span></span> : <span>äºå©· æ‡‰ä»˜ <span className="text-lg">${Math.abs(Math.round(summary.debt)).toLocaleString()}</span></span>}
                  </div>
                </div>
            </div>
          </div>
          <div className="space-y-6">
            {groupedExpenses.length === 0 && <div className="text-center text-gray-400 py-10 italic">é»æ“Šå³ä¸‹è§’ + æ–°å¢ç¬¬ä¸€ç­†æ¶ˆè²»</div>}
            {groupedExpenses.map(group => (
                <div key={group.date}>
                    <h3 className="text-xs font-bold text-gray-400 mb-3 ml-2 flex items-center gap-2"><Calendar size={12} /> {group.date}</h3>
                    <div className="space-y-3">
                        {group.items.map(ex => {
                            const catStyle = EXPENSE_CATEGORY_STYLES[ex.category] || EXPENSE_CATEGORY_STYLES['å…¶ä»–'];
                            return (
                                <div key={ex.id} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-50 flex flex-col gap-3 relative group">
                                    <button onClick={() => handleDelete(ex.id)} className="absolute top-3 right-3 text-gray-300 hover:text-red-400 p-1"><Trash2 size={14}/></button>
                                    <div className="flex justify-between items-start pr-6">
                                        <div className="flex gap-3">
                                            <div className={`w-10 h-10 rounded-full flex items-center justify-center ${catStyle.bg} ${catStyle.text}`}>{catStyle.icon}</div>
                                            <div>
                                                <div className="font-bold text-gray-800 text-base">{ex.name}</div>
                                                <div className="text-xs text-gray-400 mt-0.5 flex items-center gap-2"><span>{ex.time}</span><span className={`px-1.5 rounded text-xs ${catStyle.bg} ${catStyle.text} bg-opacity-50`}>{ex.category}</span></div>
                                            </div>
                                        </div>
                                        <div className="text-right"><div className="font-bold text-gray-800 text-lg font-noto">{ex.currency === 'JPY' ? 'Â¥' : '$'}{parseFloat(ex.amount).toLocaleString()}</div></div>
                                    </div>
                                    <div className="h-px w-full bg-gray-100"></div>
                                    <div className="flex justify-between items-center text-xs text-gray-500">
                                        <div className="flex items-center gap-4">
                                            <div className="flex items-center gap-1"><span className="text-gray-400">ä»˜æ¬¾:</span><span className={`font-bold px-2 py-0.5 rounded-full ${ex.payer==='YuTing'?'bg-pink-50 text-pink-600':'bg-blue-50 text-blue-600'}`}>{ex.payer==='YuTing'?'äºå©·':'å®ä¸€'}</span></div>
                                            <div className="flex items-center gap-1"><span className="text-gray-400">åˆ†å¸³:</span><span className="font-medium text-gray-700">{ex.split==='split' ? 'å¹³åˆ†' : ex.split==='YuTing' ? 'äºå©·å…¨ä»˜' : 'å®ä¸€å…¨ä»˜'}</span></div>
                                        </div>
                                        {ex.note && <div className="text-gray-400 italic max-w-[100px] truncate text-right">{ex.note}</div>}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            ))}
          </div>
          <button onClick={() => setShowAdd(true)} className="fixed bottom-24 right-6 w-14 h-14 rounded-full bg-[#A89F91] text-white flex items-center justify-center shadow-xl hover:bg-[#968c7e] transition-all z-40 active:scale-95"><Plus size={24} /></button>
          {showAdd && <AddExpenseModal onClose={() => setShowAdd(false)} onAdd={handleAdd} />}
        </div>
      );
}

const AddExpenseModal = ({ onClose, onAdd }) => {
  const [form, setForm] = useState({ date: new Date().toLocaleDateString('zh-TW', {year:'numeric', month:'2-digit', day:'2-digit'}).replace(/\//g, '/'), time: '12:00', amount: '', currency: 'JPY', name: '', category: 'é£Ÿ', payer: 'YuTing', split: 'split', note: '' });
  const handleSubmit = () => { if (!form.name || !form.amount) return; onAdd(form); };
  return (
    <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-4">
      <div className="bg-white w-full max-w-sm rounded-3xl p-6 animate-slide-up shadow-2xl">
        <div className="flex justify-between items-center mb-4"><h3 className="text-lg font-bold text-[#4A4A4A]">æ–°å¢æ¶ˆè²»</h3><button onClick={onClose} className="p-1 rounded-full hover:bg-gray-100"><X size={20} className="text-gray-400"/></button></div>
        <div className="grid grid-cols-2 gap-3 mb-3">
             <input type="date" className="w-full p-3 bg-gray-50 rounded-xl border border-gray-100 outline-none text-sm" value={form.date.replace(/\//g, '-')} onChange={e => setForm({...form, date: e.target.value.replace(/-/g, '/')})} />
             <input type="time" className="w-full p-3 bg-gray-50 rounded-xl border border-gray-100 outline-none text-sm" value={form.time} onChange={e => setForm({...form, time: e.target.value})} />
        </div>
        <div className="flex gap-3 mb-3">
          <input className="flex-1 w-full p-3 bg-gray-50 rounded-xl border border-gray-100 focus:outline-none focus:ring-2 focus:ring-[#A89F91] text-lg font-bold" type="number" placeholder="é‡‘é¡" value={form.amount} onChange={e=>setForm({...form, amount: e.target.value})} />
          <select className="w-24 p-3 bg-gray-50 rounded-xl border border-gray-100 outline-none font-bold text-center" value={form.currency} onChange={e=>setForm({...form, currency: e.target.value})}><option value="JPY">JPY</option><option value="TWD">TWD</option></select>
        </div>
        <input className="w-full p-3 bg-gray-50 rounded-xl border border-gray-100 outline-none mb-3" placeholder="åç¨±" value={form.name} onChange={e=>setForm({...form, name: e.target.value})} />
        <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar mb-4">{Object.keys(EXPENSE_CATEGORY_STYLES).map(cat => { const style = EXPENSE_CATEGORY_STYLES[cat]; return (<button key={cat} onClick={()=>setForm({...form, category: cat})} className={`flex-shrink-0 px-3 py-2 rounded-lg text-xs font-bold border transition-all flex items-center gap-1 ${form.category===cat ? `${style.bg} ${style.text} border-transparent` : 'bg-white text-gray-500 border-gray-200'}`}>{style.icon} {cat}</button>); })}</div>
        <div className="grid grid-cols-2 gap-3 mb-4 p-3 bg-gray-50 rounded-xl border border-gray-100">
            <div><label className="text-xs text-gray-400 block mb-1 text-center">ä»˜æ¬¾</label><div className="flex bg-white rounded-lg p-1 border border-gray-100"><button onClick={()=>setForm({...form, payer: 'YuTing'})} className={`flex-1 py-1.5 rounded-md text-xs font-bold transition-all ${form.payer==='YuTing' ? 'bg-pink-100 text-pink-600' : 'text-gray-400'}`}>äºå©·</button><button onClick={()=>setForm({...form, payer: 'HongYi'})} className={`flex-1 py-1.5 rounded-md text-xs font-bold transition-all ${form.payer==='HongYi' ? 'bg-blue-100 text-blue-600' : 'text-gray-400'}`}>å®ä¸€</button></div></div>
            <div><label className="text-xs text-gray-400 block mb-1 text-center">åˆ†å¸³</label><select className="w-full p-1.5 bg-white rounded-lg border border-gray-100 text-xs font-bold text-center outline-none h-[34px]" value={form.split} onChange={e=>setForm({...form, split: e.target.value})}><option value="split">å¹³åˆ†</option><option value="YuTing">äºå©·å…¨ä»˜</option><option value="HongYi">å®ä¸€å…¨ä»˜</option></select></div>
        </div>
        <button onClick={handleSubmit} className="w-full bg-[#4A4A4A] text-white py-4 rounded-xl font-bold shadow-md hover:bg-[#333]">ç¢ºèªè¨˜å¸³</button>
      </div>
    </div>
  );
};
// --- SVG åº•åœ– (KyotoMapSVG) ---
// ä½¿ç”¨ shape-rendering="geometricPrecision" æå‡å‘é‡ç•«è³ª
const KyotoMapSVG = React.memo(({ zoom }) => (
  <svg width="1200" height="1600" viewBox="0 0 1200 1600" className="pointer-events-none" shapeRendering="geometricPrecision" textRendering="geometricPrecision">
    {/* åº•è‰² + ç´‹ç† */}
    <rect width="100%" height="100%" fill="#f9f8f4" />
    <defs>
      <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
        <circle cx="2" cy="2" r="1" fill="#e0e0e0" />
      </pattern>
    </defs>
    <rect width="100%" height="100%" fill="url(#grid)" />

    {/* --- åœ°å½¢å€åŸŸ (Zones) --- */}
    {/* å·¦å´åµå±±å±±è„ˆ */}
    <path d="M0 0 V1000 Q 150 800 250 500 Q 100 200 0 0" fill="#E8EDE4" stroke="#D3DACD" strokeWidth="1" />
    {/* å³å´æ±å±±å±±è„ˆ */}
    <path d="M1200 0 V1600 Q 900 1200 900 800 Q 900 400 1200 0" fill="#E8EDE4" stroke="#D3DACD" strokeWidth="1" />
    
    {/* äº¬éƒ½å¾¡è‹‘ (å¤§å¡Šç¶ åœ°) */}
    <rect x="580" y="580" width="100" height="160" fill="#DAE6D6" rx="4" stroke="#B8C4B0" strokeWidth="1.5" />
    {/* äºŒæ¢åŸ */}
    <rect x="480" y="700" width="80" height="80" fill="#DAE6D6" rx="4" stroke="#B8C4B0" strokeWidth="1.5" />
    {/* ä¸‹é´¨ç¥ç¤¾æ£®æ— */}
    <path d="M780 400 Q 820 450 780 500" fill="#DAE6D6" stroke="#B8C4B0" strokeWidth="1.5" />

    {/* --- æ°´ç³» (Rivers) --- */}
    {/* é´¨å· (Yå­—å‹æ ¸å¿ƒ) */}
    <path d="M 780 0 Q 780 450 800 500 L 800 1600" stroke="#D0E3F0" strokeWidth="24" fill="none" strokeLinecap="round" />
    <path d="M 780 0 Q 780 450 800 500 L 800 1600" stroke="#A9C7D9" strokeWidth="2" fill="none" strokeLinecap="round" /> {/* é‚Šæ¡† */}
    
    <path d="M 600 0 Q 650 400 800 500" stroke="#D0E3F0" strokeWidth="18" fill="none" strokeLinecap="round" /> {/* è³€èŒ‚å·åŒ¯æµ */}
    <path d="M 600 0 Q 650 400 800 500" stroke="#A9C7D9" strokeWidth="2" fill="none" strokeLinecap="round" />
    
    {/* æ¡‚å· (è¥¿é‚Š) */}
    <path d="M 100 500 Q 200 800 200 1600" stroke="#D0E3F0" strokeWidth="20" fill="none" />
    <path d="M 100 500 Q 200 800 200 1600" stroke="#A9C7D9" strokeWidth="2" fill="none" />
    
    {/* --- é“è·¯ç³»çµ± (Grid Roads) - é›™å±¤è¨­è¨ˆ (åº•å±¤æ·±è‰²é‚Šæ¡† + ä¸Šå±¤æ·ºè‰²è·¯é¢) --- */}
    <g strokeLinecap="round">
        {/* åº•å±¤ (é‚Šæ¡†) */}
        <g stroke="#E0E0E0" strokeWidth="16">
            <line x1="0" y1="700" x2="1200" y2="700" /> {/* ä¸¸å¤ªç”ºé€š */}
            <line x1="0" y1="800" x2="1200" y2="800" /> {/* å¾¡æ± é€š */}
            <line x1="0" y1="900" x2="1200" y2="900" /> {/* å››æ¢é€š */}
            <line x1="0" y1="1000" x2="1200" y2="1000" /> {/* äº”æ¢é€š */}
            <line x1="0" y1="1100" x2="1200" y2="1100" /> {/* ä¸ƒæ¢é€š */}
            <line x1="600" y1="0" x2="600" y2="1600" /> {/* çƒä¸¸é€š */}
            <line x1="750" y1="0" x2="750" y2="1600" /> {/* æ²³åŸç”ºé€š */}
            <line x1="500" y1="0" x2="500" y2="1600" /> {/* å €å·é€š */}
        </g>
        {/* ä¸Šå±¤ (è·¯é¢) */}
        <g stroke="#FFFFFF" strokeWidth="12">
            <line x1="0" y1="700" x2="1200" y2="700" /> 
            <line x1="0" y1="800" x2="1200" y2="800" /> 
            <line x1="0" y1="900" x2="1200" y2="900" /> 
            <line x1="0" y1="1000" x2="1200" y2="1000" /> 
            <line x1="0" y1="1100" x2="1200" y2="1100" /> 
            <line x1="600" y1="0" x2="600" y2="1600" /> 
            <line x1="750" y1="0" x2="750" y2="1600" /> 
            <line x1="500" y1="0" x2="500" y2="1600" /> 
        </g>
    </g>

    {/* --- éµé“ç¶²çµ¡ (Rail Lines) --- */}
    
    {/* åœ°ä¸‹éµçƒä¸¸ç·š (Karasuma Line) - ç¶ è‰²å¯¦ç·š */}
    <line x1="600" y1="200" x2="600" y2="1600" stroke="#2ECC71" strokeWidth="6" strokeLinecap="round" />
    
    {/* åœ°ä¸‹éµæ±è¥¿ç·š (Tozai Line) - ç´…è‰²å¯¦ç·š - ä¿®æ­£è·¯ç·š */}
    {/* è·¯å¾‘ï¼šå¤ªç§¦å¤©ç¥å·(200,800) -> çƒä¸¸å¾¡æ± (600,800) -> äº¬éƒ½å¸‚å½¹æ‰€(700,800) -> ä¸‰æ¡äº¬é˜ª(830,800) -> è¹´ä¸Š(950,820) -> å¾¡é™µ(1050,850) -> å±±ç§‘(1150,900) -> é†é†(1150,1200) -> å…­åœ°è—(1100,1400) */}
    <path d="M 200 800 H 830 L 950 820 L 1050 850 L 1150 900 Q 1200 1000 1150 1200 Q 1120 1300 1100 1400" stroke="#E74C3C" strokeWidth="6" fill="none" strokeLinecap="round" />
    
    {/* äº¬é˜ªæœ¬ç·š (Keihan Line) - é»‘è‰²å¯¦ç·š (æ”¹ç‚ºé»‘è‰²) */}
    <path d="M 830 0 V 1600" stroke="#2C3E50" strokeWidth="6" strokeLinecap="round" />
    
    {/* JR åµ¯å³¨é‡ç·š (Sagano Line) - é»‘ç™½ç›¸é–“ (æ¨¡æ“¬éµè»Œ) */}
    {/* åº•å±¤é»‘è‰²å¯¦ç·š */}
    <path d="M 600 1100 Q 480 1100 480 800 Q 480 700 150 650" stroke="#2C3E50" strokeWidth="8" fill="none" strokeLinecap="round" />
    {/* ä¸Šå±¤ç™½è‰²è™›ç·š */}
    <path d="M 600 1100 Q 480 1100 480 800 Q 480 700 150 650" stroke="white" strokeWidth="4" strokeDasharray="10,10" fill="none" strokeLinecap="round" />
    
    {/* å¡å±±é›»è»Š (Eizan Line) - ç´«è‰²å¯¦ç·š */}
    <path d="M 830 450 L 830 200 L 1000 50" stroke="#8E44AD" strokeWidth="6" fill="none" strokeLinecap="round" />
    <path d="M 830 200 L 600 50" stroke="#8E44AD" strokeWidth="6" fill="none" strokeLinecap="round" />

    {/* --- è»Šç«™æ¨™è¨˜ (Stations) - å¸¸é§é¡¯ç¤º --- */}
    {/* Karasuma Line (Green) */}
    <StationLabel x={600} y={300} name="åŒ—å±±" color="#2ECC71" />
    <StationLabel x={600} y={400} name="åŒ—å¤§è·¯" color="#2ECC71" />
    <StationLabel x={600} y={500} name="éé¦¬å£" color="#2ECC71" />
    <StationLabel x={600} y={550} name="ä»Šå‡ºå·" color="#2ECC71" />
    <StationLabel x={600} y={700} name="ä¸¸å¤ªç”º" color="#2ECC71" />
    <StationLabel x={600} y={800} name="çƒä¸¸å¾¡æ± " color="#2ECC71" /> {/* äº¤æœƒé» */}
    <StationLabel x={600} y={900} name="å››æ¡" color="#2ECC71" />
    <StationLabel x={600} y={1000} name="äº”æ¡" color="#2ECC71" />
    <StationLabel x={600} y={1100} name="äº¬éƒ½" color="#2ECC71" main />
    <StationLabel x={600} y={1200} name="ä¹æ¡" color="#2ECC71" />
    <StationLabel x={600} y={1300} name="åæ¡" color="#2ECC71" />

    {/* Tozai Line (Red) */}
    <StationLabel x={200} y={800} name="å¤ªç§¦å¤©ç¥å·" color="#E74C3C" />
    <StationLabel x={400} y={800} name="è¥¿å¤§è·¯å¾¡æ± " color="#E74C3C" />
    <StationLabel x={480} y={800} name="äºŒæ¡" color="#E74C3C" />
    <StationLabel x={530} y={800} name="äºŒæ¡åŸå‰" color="#E74C3C" />
    <StationLabel x={700} y={800} name="äº¬éƒ½å¸‚å½¹æ‰€å‰" color="#E74C3C" />
    <StationLabel x={830} y={800} name="ä¸‰æ¡äº¬é˜ª" color="#E74C3C" />
    <StationLabel x={950} y={850} name="æ±å±±" color="#E74C3C" />
    <StationLabel x={1050} y={900} name="è¹´ä¸Š" color="#E74C3C" />
    <StationLabel x={1100} y={1000} name="å¾¡é™µ" color="#E74C3C" />
    <StationLabel x={1100} y={1100} name="å±±ç§‘" color="#E74C3C" />
    <StationLabel x={1150} y={1200} name="é†é†" color="#E74C3C" />
    <StationLabel x={1100} y={1400} name="å…­åœ°è”µ" color="#E74C3C" />

    {/* Keihan Line (Black) */}
    <StationLabel x={830} y={500} name="å‡ºç”ºæŸ³" color="#2C3E50" />
    <StationLabel x={830} y={650} name="ç¥å®®ä¸¸å¤ªç”º" color="#2C3E50" />
    <StationLabel x={830} y={800} name="ä¸‰æ¡" color="#2C3E50" />
    <StationLabel x={830} y={900} name="ç¥‡åœ’å››æ¡" color="#2C3E50" />
    <StationLabel x={830} y={1000} name="æ¸…æ°´äº”æ¡" color="#2C3E50" />
    <StationLabel x={830} y={1100} name="ä¸ƒæ¡" color="#2C3E50" />
    <StationLabel x={830} y={1200} name="æ±ç¦å¯º" color="#2C3E50" />
    <StationLabel x={830} y={1300} name="ä¼è¦‹ç¨²è·" color="#2C3E50" />
    <StationLabel x={830} y={1450} name="ä¸¹æ³¢æ©‹" color="#2C3E50" />

    {/* JR Sagano Line (Black/White) */}
    <StationLabel x={550} y={1080} name="æ¢…å°è·¯äº¬éƒ½è¥¿" color="#2C3E50" />
    <StationLabel x={530} y={1000} name="ä¸¹æ³¢å£" color="#2C3E50" />
    <StationLabel x={480} y={800} name="äºŒæ¡" color="#2C3E50" />
    <StationLabel x={400} y={700} name="å††ç”º" color="#2C3E50" />
    <StationLabel x={300} y={650} name="èŠ±åœ’" color="#2C3E50" />
    <StationLabel x={220} y={650} name="å¤ªç§¦" color="#2C3E50" />
    <StationLabel x={150} y={650} name="åµ¯å³¨åµå±±" color="#2C3E50" />

    {/* Eizan (Purple) */}
    <StationLabel x={830} y={400} name="å…ƒç”°ä¸­" color="#8E44AD" />
    <StationLabel x={830} y={300} name="ä¸€ä¹—å¯º" color="#8E44AD" />

    {/* --- å€åŸŸèˆ‡è·¯åæ–‡å­— (Labels) --- */}
    <g fill="#B0BEC5" fontFamily="Noto Serif TC" fontWeight="bold" opacity={0.5} style={{ pointerEvents: 'none' }}>
        <text x="850" y="450" fontSize="24" transform="rotate(10 850,450)">KAMOGAWA</text>
        <text x="150" y="750" fontSize="30" fill="#9CAF88">åµå±±</text>
        <text x="900" y="850" fontSize="28" fill="#D4A5A5">ç¥‡åœ’</text>
        <text x="950" y="1300" fontSize="24" fill="#E65100">ä¼è¦‹</text>
    </g>
    
    {/* è¡—é“åç¨± (æ”¾å¤§ > 25% é¡¯ç¤º, scale > 1.25) */}
    {zoom > 1.25 && (
        <g fill="#BDBDBD" fontSize="14" fontFamily="sans-serif">
            <text x="20" y="690">ä¸¸å¤ªç”ºé€š</text>
            <text x="20" y="790">å¾¡æ± é€š</text>
            <text x="20" y="890">å››æ¢é€š</text>
            <text x="20" y="990">äº”æ¢é€š</text>
            <text x="20" y="1090">ä¸ƒæ¢é€š</text>
            <text x="570" y="1550">çƒä¸¸é€š</text>
            <text x="760" y="1550">æ²³åŸç”ºé€š</text>
            <text x="470" y="1550">å €å·é€š</text>
        </g>
    )}
  </svg>
));

const StationLabel = ({ x, y, name, color, main }) => (
  <g transform={`translate(${x},${y})`}>
    {/* è»Šç«™åœ“é»ï¼šç™½è‰²åº•ï¼Œæ·±è‰²æ¡† */}
    <circle r={main ? 6 : 4} fill="white" stroke={color || "#546E7A"} strokeWidth="2" />
    
    {/* ç«™åï¼šæ·±ç°è‰²ï¼Œç™½è‰²æé‚Šï¼Œå¸¸é§é¡¯ç¤º */}
    <text y={-8} textAnchor="middle" fontSize={11} fill="#546E7A" fontWeight="bold" stroke="white" strokeWidth="3" paintOrder="stroke" className="font-noto pointer-events-none">
        {name}
    </text>
  </g>
);

const FilterButton = ({ type, label, active, onClick }) => (
    <button onClick={onClick} 
      className={`flex-shrink-0 px-4 py-2 rounded-full flex items-center gap-2 border transition-all shadow-sm whitespace-nowrap
      ${active ? 'bg-[#4A4A4A] text-white border-[#4A4A4A] scale-105' : 'bg-white text-gray-600 border-gray-100'}`}>
        <span>{TYPE_STYLES[type].emoji}</span>
        <span className="font-bold text-xs">{label}</span>
    </button>
);

// --- è¼”åŠ©é é¢ ---
function NavButton({ icon, label, active, onClick }) {
  return (
    <button onClick={onClick} className={`flex flex-col items-center gap-1 w-16 transition-all duration-300 ${active ? '-translate-y-2' : ''}`}>
      <div className={`p-2.5 rounded-2xl transition-all ${active ? 'bg-[#4A4A4A] text-white shadow-lg' : 'text-gray-400'}`}>
        {React.cloneElement(icon, { size: 22, strokeWidth: active ? 2.5 : 2 })}
      </div>
      <span className={`text-[10px] font-bold ${active ? 'opacity-100 text-[#4A4A4A]' : 'opacity-0'}`}>{label}</span>
    </button>
  );
}
